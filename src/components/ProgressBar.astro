---
interface Props {
  label: string;
  percentage: number;
  class?: string;
  animated?: boolean;
}

const { label, percentage, class: className, animated = true } = Astro.props;
---

<div class:list={["space-y-2", className]}>
  <div class="flex justify-between mb-1">
    <span class="font-medium text-Foreground-dark dark:text-gray-300"
      >{label}</span
    >
    <span class="font-medium text-body">
      {animated ? (
        <span class="contador-numero" data-target={percentage}>0</span>
      ) : (
        <span>{percentage}</span>
      )}%
    </span>
  </div>
  <div class="w-full bg-neutral-quaternary rounded-full h-2">
    <div
      class:list={[
        animated ? "barra-llenado" : "",
        "bg-Orange-vibrant dark:bg-Orange-vibrant-dark h-2 rounded-full transition-all duration-300",
      ]}
      style={animated ? "width: 0%" : `width: ${percentage}%`}
      data-width={percentage}
    >
    </div>
  </div>
</div>

{animated && (
  <script>
    // Lazy load GSAP solo si hay barras animadas
    async function initProgressBarAnimations() {
      const { gsap } = await import("gsap");
      const { ScrollTrigger } = await import("gsap/ScrollTrigger");
      
      gsap.registerPlugin(ScrollTrigger);

      // Limpiar triggers anteriores para evitar duplicados
      ScrollTrigger.getAll().forEach(trigger => trigger.kill());

      // Resetear el estado de las barras y contadores antes de animar
      const contadores = document.querySelectorAll(".contador-numero");
      contadores.forEach((contador) => {
        contador.textContent = "0";
      });

      const barras = document.querySelectorAll(".barra-llenado");
      barras.forEach((barra) => {
        (barra as HTMLElement).style.width = "0%";
      });

      // Animar contadores
      contadores.forEach((contador) => {
        const valorFinal = parseInt(contador.getAttribute("data-target") || "0");
        
        gsap.to(contador, {
          innerText: valorFinal,
          duration: 2,
          snap: { innerText: 1 },
          ease: "power1.out",
          scrollTrigger: {
            trigger: contador,
            start: "top 90%",
            toggleActions: "play none none none",
          },
        });
      });

      // Animar barras
      barras.forEach((barra) => {
        const porcentaje = barra.getAttribute("data-width") || "0";

        gsap.to(barra, {
          width: porcentaje + "%",
          duration: 1.8,
          ease: "expo.out",
          scrollTrigger: {
            trigger: barra,
            start: "top 95%",
            toggleActions: "play none none none",
          },
        });
      });

      ScrollTrigger.refresh();
    }

    // Ejecutar cuando haya elementos para animar
    if (document.querySelector(".contador-numero") || document.querySelector(".barra-llenado")) {
      initProgressBarAnimations();
    }

    // Ejecutar en cada navegaciÃ³n con ClientRouter
    document.addEventListener("astro:page-load", () => {
      if (document.querySelector(".contador-numero") || document.querySelector(".barra-llenado")) {
        initProgressBarAnimations();
      }
    });
  </script>
)}
